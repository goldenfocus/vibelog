name: Auto-merge after successful deploy

on:
  check_run:
    types: [completed]
  status:
    types: [success]

jobs:
  auto-merge:
    if: |
      (github.event_name == 'check_run' && github.event.check_run.conclusion == 'success') ||
      (github.event_name == 'status' && github.event.state == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: read

    steps:
      - name: Find PR for check run
        id: find-pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber = '';
            let branch = '';
            let sha = '';

            // If triggered by check_run, find PR associated with the check
            if (context.eventName === 'check_run') {
              const checkRun = context.payload.check_run;
              const checkSha = checkRun.head_sha;
              
              // Find PRs that have this commit SHA
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                base: 'main',
                sort: 'updated',
                direction: 'desc'
              });
              
              // Find PR where head SHA matches the check run SHA
              const matchingPR = prs.data.find(p => p.head.sha === checkSha);

              if (matchingPR) {
                const hasAutoMergeLabel = matchingPR.labels.some(l => l.name === 'auto-merge');
                const isAutoMergeBranch = matchingPR.head.ref.startsWith('fix/') ||
                                         matchingPR.head.ref.startsWith('feat/') ||
                                         matchingPR.head.ref.startsWith('feature/') ||
                                         matchingPR.head.ref.startsWith('claude/');

                if (hasAutoMergeLabel || isAutoMergeBranch) {
                  prNumber = matchingPR.number.toString();
                  branch = matchingPR.head.ref;
                  sha = matchingPR.head.sha;
                }
              }
            } else if (context.eventName === 'status') {
              // If triggered by status, find PR with matching SHA
              const statusSha = context.payload.sha;
              
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                base: 'main',
                sort: 'updated',
                direction: 'desc'
              });
              
              const matchingPR = prs.data.find(p => p.head.sha === statusSha);
              
              if (matchingPR) {
                const hasAutoMergeLabel = matchingPR.labels.some(l => l.name === 'auto-merge');
                const isAutoMergeBranch = matchingPR.head.ref.startsWith('fix/') ||
                                         matchingPR.head.ref.startsWith('feat/') ||
                                         matchingPR.head.ref.startsWith('feature/') ||
                                         matchingPR.head.ref.startsWith('claude/');

                if (hasAutoMergeLabel || isAutoMergeBranch) {
                  prNumber = matchingPR.number.toString();
                  branch = matchingPR.head.ref;
                  sha = matchingPR.head.sha;
                }
              }
            }

            core.setOutput('pr_number', prNumber);
            core.setOutput('branch', branch);
            core.setOutput('sha', sha);

            if (prNumber) {
              console.log(`Found PR #${prNumber} (${branch}) for auto-merge`);
            } else {
              console.log('No matching PR found for auto-merge');
            }

      - name: Wait for deployment
        if: steps.find-pr.outputs.pr_number != ''
        run: |
          echo "Waiting 3 minutes for Vercel deployment to complete..."
          sleep 180

      - name: Check Vercel deployment status
        id: check-deploy
        if: steps.find-pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.find-pr.outputs.pr_number }}');
            const sha = '${{ steps.find-pr.outputs.sha }}';

            // Check for Vercel deployment checks
            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: sha
            });

            // Look for Vercel-related checks
            const vercelChecks = checks.data.check_runs.filter(c => 
              c.name.toLowerCase().includes('vercel') || 
              c.name.toLowerCase().includes('deploy') ||
              c.app?.name?.toLowerCase().includes('vercel')
            );

            // Check if all Vercel checks passed
            const allPassed = vercelChecks.length > 0 && 
              vercelChecks.every(c => c.conclusion === 'success');

            // If no Vercel checks found, check commit status
            if (vercelChecks.length === 0) {
              const status = await github.rest.repos.getCombinedStatusForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: sha
              });
              
              const deployStatus = status.data.statuses.find(s => 
                s.context.toLowerCase().includes('vercel') ||
                s.context.toLowerCase().includes('deploy')
              );
              
              if (deployStatus && deployStatus.state === 'success') {
                core.setOutput('deploy_success', 'true');
              } else {
                core.setOutput('deploy_success', 'false');
              }
            } else {
              core.setOutput('deploy_success', allPassed ? 'true' : 'false');
            }

            const deploySuccess = allPassed || (deployStatus && deployStatus.state === 'success');
            console.log(`Deployment check: ${deploySuccess ? 'true' : 'false'}`);
            console.log(`Vercel checks found: ${vercelChecks.length}`);

      - name: Squash and merge PR
        if: steps.find-pr.outputs.pr_number != '' && steps.check-deploy.outputs.deploy_success == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = parseInt('${{ steps.find-pr.outputs.pr_number }}');
            const branch = '${{ steps.find-pr.outputs.branch }}';

            // Get PR details first
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Only merge if still open
            if (pr.data.state === 'open' && !pr.data.merged) {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash'
              });
              
              console.log(`✅ Squash merged PR #${prNumber}`);
              
              // Try to delete branch (may already be deleted)
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${branch}`
                });
                console.log(`✅ Deleted branch: ${branch}`);
              } catch (error) {
                console.log(`Branch ${branch} may already be deleted`);
              }
            } else {
              console.log(`PR #${prNumber} is already ${pr.data.state}`);
            }

      - name: Trigger wiki sync if needed
        if: steps.find-pr.outputs.pr_number != '' && steps.check-deploy.outputs.deploy_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'wiki-sync.yml',
                ref: 'main'
              });
              console.log('✅ Triggered wiki sync workflow');
            } catch (error) {
              console.log('⚠️  Could not trigger wiki sync:', error.message);
            }
